box: wercker/golang
build:
  steps:
    - script:
        name: Enable verbose git ssh logging
        code: |-
          echo 'ssh -v $@' > $HOME/git_ssh
          chmod +x $HOME/git_ssh
          export GIT_SSH="$HOME/git_ssh"
  
    - script:
        name: Setup deploy key
        code: |-
          mkdir -p "$HOME/.ssh"
          cd "$HOME/.ssh"
        
          echo "$MYPACKAGE_KEY_PRIVATE" > id_rsa_mypackage
          chmod 0700 id_rsa_mypackage
          
          #sed -i -e "1i IdentityFile $HOME/.ssh/id_rsa_mypackage" config
          echo "IdentityFile $HOME/.ssh/id_rsa_mypackage" > config
          chmod 0600 config
    - script:
        name: Echo private key
        code: |-
          echo $MYPACKAGE_KEY_PRIVATE
          
    - script:
        name: Echo .ssh/config
        code: |-
          echo '$HOME/.ssh/id_rsa_mypackage'
          cat "$HOME/.ssh/id_rsa_mypackage"
          
          echo '$HOME/.ssh/config'
          cat "$HOME/.ssh/config"
  
    - pjvds/setup-go-workspace
    
    - script:
        name: Clone private packages
        code: |-
          mkdir -p $GOPATH/src/github.com/pjvds/private-project
          git clone git@github.com:pjvds/private-project.git $GOPATH/src/github.com/pjvds/private-project

    # - script:
    #     name: Populate cache
    #     code: |-
    #         # BEFORE YOU COPY AND USE THIS STEP IN YOUR OWN BUILD PIPELINE
    #         # MAKE SURE YOU SET $WERCKER_SOURCE_DIR TO THE PACKAGE DIRECTORY
    #         # OR YOUR PROJECT, LIKE: $GOPATH/github.com/pjvds/httpcallback.io
    #         if test -d "$WERCKER_CACHE_DIR/go-pkg-cache"; then rsync -avzv --exclude "$WERCKER_SOURCE_DIR" "$WERCKER_CACHE_DIR/go-pkg-cache/" "$GOPATH/" ; fi

    - script:
        name: Get dependencies
        code: |-
            go get -v ./...

    - script:
        name: Build
        code: |
            go build -a -v ./...

    - script:
        name: Test
        code: |-
            go test ./...

    - script:
        name: Store cache
        code: |-
            # BEFORE YOU COPY AND USE THIS STEP IN YOUR OWN BUILD PIPELINE
            # MAKE SURE YOU SET $WERCKER_SOURCE_DIR TO THE PACKAGE DIRECTORY
            # OR YOUR PROJECT, LIKE: $GOPATH/github.com/pjvds/httpcallback.io
            rsync -avzv --exclude "$WERCKER_SOURCE_DIR" "$GOPATH/" "$WERCKER_CACHE_DIR/go-pkg-cache/"

    - script:
        name: Copy output
        code: |-
          rsync -avz "$WERCKER_SOURCE_DIR/" "$WERCKER_OUTPUT_DIR"
